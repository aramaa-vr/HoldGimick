#!/bin/bash

# ==============================================================================
# VPMパッケージZIPファイル作成スクリプト (Git Bash版)
#
# このスクリプトは、VRChatアバター向け「みんなでつかめるだこちてギミック」の
# VPM (VRChat Package Manager) 互換ZIPパッケージを作成します。
# ZIPファイルには、HoldGimickフォルダの中身が直接含まれ、不要な階層が排除されます。
#
# 使用前に、スクリプトを実行するGit Bashのターミナルが、
# Unityプロジェクトのルートディレクトリで開かれていることを確認してください。
#
# ------------------------------------------------------------------------------
# 実行コマンド例:
#
# 1. バージョンを指定してZIPを作成する場合:
#    ./create_vpm_zip.sh 0.6.1
#
# 2. バージョンを省略してデフォルト (0.6.1) でZIPを作成する場合:
#    ./create_vpm_zip.sh
#
# ==============================================================================

# 7-Zip実行ファイルへのパスを定義します。
# !!! 7-Zipのインストール先が異なる場合は、このパスを修正してください !!!
# 例: 32ビット版Windowsの場合: SEVEN_ZIP_PATH="/c/Program Files (x86)/7-Zip/7z.exe"
SEVEN_ZIP_PATH="/c/Program Files/7-Zip/7z.exe"

# バージョン番号を引数から取得します。
# 引数がない場合はデフォルト値として "0.6.1" を使用します。
VERSION="${1:-0.6.1}"

# 作成するZIPファイル名
ZIP_FILE_NAME="jp.aramaa.holdgimick-${VERSION}.zip"

# VPMパッケージのルートとなる一時ディレクトリを作成します。
# 既存の場合は上書きします。
mkdir -p ./VPM_TEMP

# 既に同じ名前のZIPファイルが存在する場合は削除します。
# これにより、常に新しい内容でZIPファイルが作成されます。
if [ -f "$ZIP_FILE_NAME" ]; then
    echo "既存のZIPファイル $ZIP_FILE_NAME を削除します。"
    rm -f "$ZIP_FILE_NAME"
fi

# ギミック本体の全アセット（ファイル、サブフォルダ、.metaファイルを含む）を
# 一時ディレクトリの直下にコピーします。
# 'cp -r SOURCE/. DEST/' の形式で、SOURCEディレクトリの中身をDESTにコピーします。
cp -r ./Assets/Aramaa/HoldGimick/. ./VPM_TEMP/

# 一時ディレクトリの内容をZIPファイルに圧縮します。
# 出力されるZIPファイルは、Unityプロジェクトのルートディレクトリに作成されます。
# 一時ディレクトリに移動してから、その内容をZIPのルートに追加します。
# '*' を使うことで、VPM_TEMP内のすべてのファイルとディレクトリを直接ZIPのルートに含めます。
# ZIPファイル名に取得したバージョン番号を使用します。
(cd ./VPM_TEMP && "$SEVEN_ZIP_PATH" a -tzip "../$ZIP_FILE_NAME" *)

# ZIPファイルの作成に使用した一時ディレクトリを削除します。
rm -rf ./VPM_TEMP

# ZIPファイルが正常に作成されたことを示すメッセージを表示します。
echo "VPMパッケージZIPファイル $ZIP_FILE_NAME が作成されました。"